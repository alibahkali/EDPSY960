---
title: "EP 960 Multiple Group CFA"
author: "David Kaplan"
output:
  html_document: default
pdf_document: default

---
  
```{r,echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Install relevant packages
install.packages("lavaan")

install.packages("semTools")

```{r,echo=TRUE}
library(lavaan)
library(semTools)
library(dplyr)
```

### Read in data and remove missing data listwise.  Data come from the National Educational Longitudinal Study of 1988. Note:  Private school coded 1, Public School coded 0.  Scales in the original data are coded 1=strongly agree, 4=strongly disagree


```{r,echo=TRUE}
mgcfa <- read.csv("~/desktop/newpubpriv.csv",header=T)

# Label 0 = public and 1 = private.
mgcfa$private <- factor(mgcfa$private,
                    levels = c(0,1),
                    labels = c("public", "private"))

### Recode to 1 = strongly disagree, 4=strongly agree

mgcfa[,c(3:17)] <- 5-mgcfa[,c(3:17)]
head(mgcfa)
```

# Specify model for both groups

```{r,echo=TRUE}
schclimate <- ' 
pos =~ getalng+spirit+fair+racefrnd+
tchgood+tchint+tchprais+listen

neg =~ disrupt+putdown+studown+feelsafe+impede+
misbehav+strict

'
```

# Obtain results for configural invariance

```{r,echo=TRUE}
fitconfig <- cfa(schclimate,data=mgcfa,group="private")
summary(fitconfig,fit.measures=TRUE)
```

There is some evidence on the basis of alternative fit indices and the RMSEA that the number of factors are the same for both groups.

# Obtain results for metric invariance

```{r, echo=TRUE}
fitmetric <- cfa(schclimate,data=mgcfa,group="private",group.equal="loadings")
summary(fitmetric,fit.measures=TRUE)
```
Notice how the factor loadings are held equivalent across the groups.

# Obtain results for scalar invariance

```{r, echo=TRUE}
fitscalar <- cfa(schclimate,data=mgcfa,group="private",group.equal=c("loadings","intercepts"))
summary(fitscalar,fit.measures=TRUE)
```

Notice that the loadings and intercepts are held equal across the groups, allowing identification of the factor means.  They appear at the bottom of the "Intercepts:" section. Lavaan provides the codes within the data set in brackets.  Group 1 latent means are the reference, and Group 2 are latent mean differences from Group 1. So, we see that private students (Group 2) show higher levels of positive school climate attitudes, and lower negative school climate attitudes than public school students (Group 1).

# Compare model fit statistics
```{r,echo=TRUE}
anova(fitconfig,fitmetric,fitscalar)
```

This table provides an easy way to see the changes in fit amongst the models.  On the basis of the BIC , the metric invariance model is preferred.

