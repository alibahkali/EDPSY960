---
title: "EP 960 Path analysis in two groups"
author: "David Kaplan"
output:
  html_document:
    df_print: paged
  pdf_document: default
pdf_document: default
fig_caption: yes
---
  
```{r,echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Install necessary packages and load

install.packages("lavaan")
install.packages("semTools")
install.packages("dplyr")


```{r,echo=TRUE}
library(lavaan)
library(semTools)
library(dplyr)
```
# Read in data
```{r,echo=TRUE}
scimodel <- read.csv("~/desktop/sciex.csv",header=T)
summary(scimodel)
```

# Label 0 = Not Certified and 1 = Certified

```{r,echo=TRUE}
scimodel$certsci <- factor(scimodel$certsci,
                    levels = c(0,1),
                    labels = c("notCertified", "Certified"))

```


# Set up lavaan code for both groups
```{r,echo=TRUE}
pathmodel <- ' 

# regressions
sciach ~ scigrade10
scigrade10 ~ scigrade6+ses++understand+challenge
challenge~understand



'

```

# Obtain summary of path analysis
```{r,echo=TRUE}
fitGroups <- sem(pathmodel,data=scimodel, estimator="mlr",group="certsci",group.equal="regressions")
summary(fitGroups, fit.measures=TRUE)
```
We find that model does not fit the data as evidenced by a number of fit statistics.  This suggests that constraining the regression coefficients to be equal across groups cannot be supported.  This is indicative of some moderating effect.  

# Obtain standardized solution
```{r,echo=TRUE}
standardizedSolution(fitGroups)
```

This is the standardized solution interpreted as standardized regression coefficients.




# Obtain modification indices to look for moderating effect of certsci.
```{r,echo=TRUE}
modindices1 <- modindices(fitGroups,standardized=TRUE,power=TRUE,delta=0.1,alpha=.05,high.power=.80)
modindices1$decision = as.factor(modindices1$decision)
modindices1$decision = factor(modindices1$decision, levels(modindices1$decision)[c(3,4,1,5,2)])
modindices1 %>%
  mutate_if(is.numeric, ~round(.,1)) %>%
  subset(op != "~~") %>%
  arrange(desc(abs(epc))) %>%
  arrange(decision)
```

These are the modification indices used to determine which constrained regressions could possibly be freed leading to an improvement in model fit.  It's not quite clear in this example as the biggest MI and EPC are associated with the regression of science achievement on SES and the regression coefficients (if freed) would be about the same.  Nonetheless, we can free this particular constraint to see what happens. 

```{r,echo=TRUE}
pathmodel2 <- ' 

# regressions
sciach ~ ses+scigrade10
scigrade10 ~ scigrade6+ses++understand+challenge
challenge~understand

'
```

```{r,echo=TRUE}
fitGroupsM2 <- sem(pathmodel2,data=scimodel, estimator="mlr",group="certsci",group.equal="regressions",group.partial=c("sciach~ses"))
summary(fitGroupsM2, fit.measures=TRUE)
```

We find a major improvement in the fit of the model, however with all other paths constrained to be equal, the substantive differences between the schools whose teachers are certified to teach science and those that are not is not very different.  The improvement is mostly due overall to simply adding the SES to SCIACH path.  This is consistent with what was found in the path analysis.  We would conclude that there doesn't seem to be any moderating effect of teacher certification on science.