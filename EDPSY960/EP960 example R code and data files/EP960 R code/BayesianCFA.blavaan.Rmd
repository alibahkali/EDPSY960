---
title: "Bayesian CFA with blavaan: Non-informative and informative priors with comparisons"
author: "David Kaplan"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,echo=TRUE}
library(rstan)  
library(blavaan)
```

# Read in data

```{r, echo=TRUE}
CanadaCFA <-read.csv("~/desktop/Canada.csv",header=TRUE) # browse to select data
CanadaCFA <- subset(CanadaCFA, select=c(ASBR08A,ASBR08B,ASBR08C,ASBR08D,ASBR08E,ASBR08F,ASBR08G))
names(CanadaCFA) <- c("dowell","easy","harder","interesting","difficultwords","teacherpraise","otherthings")

######
# dowell - I usually do well in reading
# easy - Reading is easy for me
# harder - Reading is harder for me than for many of my classmates
# interesting - If a book is interesting, I donâ€™t care how hard it is to read
# difficultwords - I have trouble reading stories with diffi cult words
# teacherpraise - My teacher tells me I am a good reader 
# otherthings - Reading is harder for me than any other subject
#######

CanadaCFA <- CanadaCFA[1:2000,] # Cutting down the sample size
CanadaCFA[CanadaCFA==999999]=NA
CanadaCFA <- na.omit(CanadaCFA)
```

# blavaan is a very powerful package for Bayesian structural equation modeling and factor analysis which uses the lavaan syntax but is also a front end for Stan.

We specify a CFA model with two factors and non-informative default priors
```{r, echo=TRUE}
CanadaCFAmodel1 <- ' PosRead =~ dowell+easy+interesting
                    NegRead =~ harder+difficultwords+otherthings'
```

Here we run the analysis and obtain the summary.  The number of chains is 3 by default.  We control the number of burnin and post-burnin samples
```{r, echo=TRUE}
CFAfitNonINf <- bcfa(CanadaCFAmodel1, data=CanadaCFA, burnin = 5000, sample=5000,bcontrol=list(cores=4))
```

We can look at the default priors used by blavaan
```{r, echo=TRUE}
blavInspect(CFAfitNonINf, "dp")
```

# Trace and density plots
```{r, echo=TRUE}
plot(CFAfitNonINf,plot.type=c("trace"))
plot(CFAfitNonINf,plot.type=c("dens"))
```

The convergence diagnostics look good

# Results
```{r, echo=TRUE}
blavInspect(CFAfitNonINf, "postmean")
blavInspect(CFAfitNonINf, "psrf")
blavInspect(CFAfitNonINf, "hpd")
```

Posterior predictive checks using two common methods for assessing the quality of the fit in CFA
```{r, echo=TRUE}
FIs1chisq <- ppmc(CFAfitNonINf, thin=10, fit.measures="chisq")
plot(FIs1chisq)
FIs1rmsea <- ppmc(CFAfitNonINf, thin=10, fit.measures="rmsea")
plot(FIs1rmsea)
```

We find on the basis of the PPCs that the model does not fit the data. Note that both the chi-square and RMSEA will be sensitive to the sample size. 


# Informative model and model comparison

We specify a CFA model with two factors and non-informative default priors.  

```{r, echo=TRUE}
CanadaCFAmodel2<- ' PosRead =~ dowell+easy+interesting
                    NegRead =~ harder+difficultwords+otherthings'
```

Here we run the analysis and obtain the summary.  The number of chains is 3 by default.  We control the number of burnin and post-burnin samples.  Here, for simplicity we put an informative prior on the loadings and leave the other parameters at their default priors.
```{r, echo=TRUE}
CFAfitINf <- bcfa(CanadaCFAmodel2, data=CanadaCFA, burnin = 5000, sample=5000,bcontrol=list(cores=4),dp=dpriors(lambda="normal(.7,1)"))
```
We can look at the default priors used by blavaan
```{r, echo=TRUE}
blavInspect(CFAfitINf, "dp")
```

# Trace and density plots
```{r, echo=TRUE}
plot(CFAfitINf,plot.type=c("trace"))
plot(CFAfitINf,plot.type=c("dens"))
blavInspect(CFAfitINf, "psrf")
```

The convergence diagnostics look good.

# Results
```{r, echo=TRUE}
blavInspect(CFAfitINf, "postmean")
blavInspect(CFAfitINf, "hpd")
```

Posterior predictive checks using two common methods for assessing the quality of the fit in CFA
```{r, echo=TRUE}
FIs2chisq <- ppmc(CFAfitINf, thin=10, fit.measures="chisq")
plot(FIs2chisq)
FIs2rmsea <- ppmc(CFAfitINf, thin=10, fit.measures="rmsea")
plot(FIs2rmsea)
```

For both models, the posterior predictive p-value shows considerable lack of fit.  Note that both the chi-square and RMSEA will be sensitive to the sample size. 

Compare non-informative and informative models using LOO, WAIC, and the log-Bayes factor
```{r, echo=TRUE}
blavCompare(CFAfitNonINf,CFAfitINf)
```

The two models are barely distinguishable on the basis of the LOO and WAIC.  The BIC (used for discrete model choice) favors the model with the informative prior.  However, given that neither model shows adequate posterior predictive performance in terms of chi-square and rmsea, it is probably a good idea to examine the specification of the model. 