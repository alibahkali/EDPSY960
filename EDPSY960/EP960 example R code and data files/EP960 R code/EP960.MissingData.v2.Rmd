---
title: "EP 960 Issues of Missing Data"
author: "David Kaplan"
output:
  html_document: default
  pdf_document: default
---
# Install relevant packages

install.packages("lavaan")

install.packages("mice")

install.packages("naniar")

```{r,echo=TRUE}
library(mice)
library(lavaan)
library(semTools)
library(naniar)
```
```{r,echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Read in data

```{r,echo=TRUE}
PISAmiss <- read.csv("~/desktop/ProblemSet2.PISA2012.csv",header=T)
PISAmiss[PISAmiss==999]=NA
```

```{r,echo=TRUE}
PISAmiss.model <- ' F1 =~ enjoyread+lookforward+enjoy+interest
					F2 =~ effort+career+important+job '
```

### Test MCAR
```{r, echo=TRUE}
mcar_test(PISAmiss)
```

Note that the null hypothesis is that the missing data are MCAR.  So, we see that the MCAR test is rejected and therefore, we must assume either MAR or NMAR.  Recall that most ad hoc methods assume MCAR which is clearly an incorrect assumption in this analysis.


### ML under listwise deletion
```{r,echo=TRUE}
fitlistwise <- sem(PISAmiss.model,data=PISAmiss)
summary(fitlistwise, fit.measures=TRUE)
```

Notice that for this example there is not a lot of missing data, though the missing data are not MCAR.  We might now see a lot of differences across methods. For the purposes of this demonstration, let's keep an eye on the chi-square statistics.

### ML and FIML Estimation for Missing Data
```{r,echo=TRUE}

fitFIML <- sem(PISAmiss.model,data=PISAmiss,estimator="ml", missing="FIML")
summary(fitFIML, fit.measures=TRUE)
```

The results using FIML for this case are slightly worse than ML.

# Handling non-normality and missing data using "MLR" #
```{r,echo=TRUE}
fitmlr <- sem(PISAmiss.model,data=PISAmiss,estimator="mlr", missing="FIML")
summary(fitmlr, fit.measures=TRUE)
```
We see in this example that handling missing data and non-normality yields (comparatively) the best fit so far


### Multiple imputation using predictive mean matching via "mice" and "mlr" ###

```{r,echo=TRUE}
PISAmiss_imp <- mice(PISAmiss, m = 20, method="pmm")
mice.imp <- NULL
for(i in 1:20) { mice.imp[[i]] <- complete(PISAmiss_imp, action=i, inc=FALSE)  
}
```
# Run lavaan with previously imputed data using runMI  
```{r,echo=TRUE}
fitmi <- cfa.mi(PISAmiss.model,estimator="mlr",
              data=mice.imp)
summary(fitmi)
lavTestLRT.mi(fitmi,test="D2",asymptotic=TRUE,pool.robust=TRUE)
fitMeasures(fitmi,fit.measures="all")

```

We see that there are differences in the results though they are not very large.  Note that the last procedure (multiple imputation with mlr) is the state of the art for handling missing data and moderate non-normality.  Here you would report the chisq.scaled, rmesa.scaled, tli.scaled, and cfi.scaled.  There is no scaling of the AIC or BIC.