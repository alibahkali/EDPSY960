---
title: "EP 960 Bayesian Path analysis: Default Priors"
author: "David Kaplan"
output:
  html_document: default
pdf_document: default
fig_caption: true
---
  
```{r,echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Install necessary packages and load

install.packages("lavaan")

install.packages("semTools")


```{r,echo=TRUE}
library(blavaan)
library(lavaan)
library(semTools)
```
# Read in data
```{r,echo=TRUE}
scimodel <- read.csv("~/desktop/sciex.csv",header=T)
```

# Set up blavaan code for Model 1
```{r,echo=TRUE}
pathmodel1 <- ' 

# regressions
sciach ~ A*scigrade10
scigrade10 ~ B*scigrade6+C*ses+D*certsci+E*understand+F*challenge
challenge~G*understand
understand ~ H*certsci

# Mediation analysis

# Indirect effect of ses on SCIACH through SCIGRA10

CA := C*A


# Indirect effect off CERTSCI on SCIACH through SCIGRA10

AD := A*D

# Indirect effect off CERTSCI on SCIACH through UNDERSTD and SCIGRA10

AEH := A*E*H

# Indirect effect of CERTSCI on SCIACH through UNDERSTD CHALLG and SCIGRA10

AFGH := A*F*G*H


# Total indirect effect of CERTSCI on SCIACH

AD_AEH_AFGH := AD + AEH + AFGH

'
```

# Start estimation
```{r, echo=TRUE}
fitm1 <- bsem(pathmodel1, data=scimodel, burnin = 2000, sample=5000)
```

# Obtain diagnostics plots
```{r,echo=TRUE}
M1Trace <- plot(fitm1, plot.type="trace")
M1dens <- plot(fitm1, plot.type="dens")
M1neff <- blavInspect(fitm1, "neff")
M1neff
```

Notice that there is reasonably good evidence of convergence of the algorithm. The trae plots have a nice horizontal band with with all chains merged.  The density plots are more or less normall shapped.  The effective sample size is a way to guage autocorrelcation.  The effect sample size should be close to the number of actual draws that go into estimating the posterior distribution.  We see that the effective sample size suggests little autocorrelation and therefore the algorithm under these settings was effective in exploring the full posterior distribution.  


```{r,echo=TRUE}
summary(fitm1)
```

The output contains the posterior means, standard deviations, lower and upper bounds of the 95% posterior interval. In addition, the default (non-informative priors are presented.  The prior gamma(1,5)[sd] means that this prior is being place on the standard deviation.   

Notice first that the rhats are all around 1.0. This is another indicator of algorithm convergence when there is more than one chain.  Here we find good mixing of the chains.  Also, notice that the estimates are very close to what was obtained in the frequentist analysis.  This is due in part to the non-informative priors and the rather large sample sizes.  Note that with the posterior estimates and standard deviations, a rich set of follow-up analyses are possible.  



# Obtain plots of model fit
```{r,echo=TRUE}
M1Fit <- ppmc(fitm1, thin=10, fit.measures=c("rmsea","chisq"))
plot(M1Fit,element="chisq")
plot(M1Fit,element="rmsea")

```

We notice that the model has terrible fit to the data as evidenced by the posterior predictive model checks using chi-square and RMSEA.  This is consistent with the frequentist results.


# Model 2 with SES to SCIACH added

# Set up blavaan code for Model 2

```{r,echo=TRUE}
pathmodel2 <- ' 

# regressions
sciach ~ A*scigrade10 + I*ses
scigrade10 ~ B*scigrade6+C*ses+D*certsci+E*understand+F*challenge
challenge~G*understand
understand ~ H*certsci

# Mediation analysis

# Indirect effect of ses on SCIACH through SCIGRA10

CA := C*A


# Indirect effect off CERTSCI on SCIACH through SCIGRA10

AD := A*D

# Indirect effect off CERTSCI on SCIACH through UNDERSTD and SCIGRA10

AEH := A*E*H

# Indirect effect of CERTSCI on SCIACH through UNDERSTD CHALLG and SCIGRA10

AFGH := A*F*G*H


# Total indirect effect of CERTSCI on SCIACH

AD_AEH_AFGH := AD + AEH + AFGH

# Total effect of SES on SCIACH through SCIGRA10

I_CA := I + C*A

'
```

# Start estimation
```{r, echo=TRUE}
fitm2 <- bsem(pathmodel2, data=scimodel, burnin = 2000, sample=5000)
```

# Obtain diagnostics plots
```{r,echo=TRUE}
M2Trace <- plot(fitm2, plot.type="trace")
M2dens <- plot(fitm2, plot.type="dens")
M2neff <- blavInspect(fitm2, "neff")
M2neff
```
Again, we see good evidence of convergence.

```{r,echo=TRUE}
summary(fitm2)
```

# Obtain plots of model fit
```{r,echo=TRUE}
M2Fit <- ppmc(fitm2, thin=10, fit.measures=c("rmsea","chisq"))
plot(M2Fit,element="chisq")
plot(M2Fit,element="rmsea")

```

Although these plots show slight improvement, this modified model still does not fit.

# Model comparison using leave-one-out cross-validation
```{r, echo=TRUE}
blavCompare(fitm1, fitm2)
```

We find that Model 2 has the lowest LOOIC value and is favored as the model with the best out-of-sample predictive performance.
